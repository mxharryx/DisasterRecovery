trigger:
  - main

pool:
  vmImage: 'windows-latest'

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'AzureSPConnection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Install the Azure Site Recovery CLI extension
        az extension add --name site-recovery
        
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'AzureSPConnection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Start a test failover
        az site-recovery recovery-plan test-failover initiate `
        --resource-group RecoveryRG `
        --vault-name RecoveryVault `
        --recovery-plan-name PrimaryVMRecoveryPlan `
        --network-id /subscriptions/5518087e-908d-4cb5-ac6a-d09d9eef4fb6/resourceGroups/RecoveryRG/providers/Microsoft.Network/virtualNetworks/RecoveryVNet

  - task: AzureCLI@2
    inputs:
      azureSubscription: 'AzureSPConnection'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Commit the failover after validation (optional)
        az site-recovery recovery-plan test-failover cleanup `
        --resource-group RecoveryRG `
        --vault-name RecoveryVault `
        --recovery-plan-name PrimaryVMRecoveryPlan
